# GeotabVibe — Fleet Command Center

**Conversational fleet management powered by Geotab + Google Maps + Gemini AI + Ace AI**

> Talk to your fleet. Ask questions in plain English, get real-time answers from your Geotab telematics data — with a live Google Maps dashboard, AI-powered analysis, animated trip replay, voice control, and one-click executive reports.

Built for the [Geotab Vibe Coding Competition 2026](https://luma.com/h6ldbaxp).

## The Problem

Fleet managers juggle multiple dashboards, reports, and interfaces to answer simple questions: *"Which truck has the worst fuel efficiency?"*, *"Are there any active fault codes?"*, *"How did our drivers score on safety this week?"*

Out of 776+ solutions in the Geotab Marketplace, **zero** offer a conversational AI interface. Fleet managers are stuck clicking through menus instead of just asking.

## The Solution

A full-stack fleet command center that combines:

- **20 MCP tools** for any AI assistant (Claude, GPT, etc.) to query and manage fleet data via natural language
- **Live Google Maps dashboard** with real-time vehicle tracking, heatmaps, and geofence overlays
- **Gemini AI chat** with function calling (create zones, send messages, query exceptions, analyze data)
- **Geotab Ace AI integration** for fleet-native insights
- **Trip replay** with GPS breadcrumb animation, speed-colored paths, and telemetry HUD
- **Executive reports** generated by Gemini + Ace AI, exportable as HTML/PDF
- **Voice control** via Web Speech API — trigger the demo, ask questions, control the dashboard by voice
- **Automated demo** with TTS narration (Gemini Native Audio) — 3-minute guided tour showcasing every feature
- **SQLite vehicle enrichment** for presentation-grade fleet data
- **Persistent SQLite response cache** with DB-first architecture — zero API calls on cached data

```
You: "Show me all vehicles in my fleet"
AI:  Here are your 50 vehicles — 15 vans, 12 pickups, 8 sedans, 8 SUVs, 4 EVs, 3 heavy trucks...

You: "Which one has the worst fuel efficiency this month?"
AI:  Unit 48 — Hino 195 averaged 4.2 MPG, significantly below fleet average of 6.8 MPG.

You: "Create a geofence around 123 Main St, Toronto"
AI:  Geocoded → Created zone 'Main St Depot' with 500m radius. ✓

You: "Generate a fleet report"
AI:  [Opens executive report with Gemini analysis + Ace AI insights — Print/Save HTML/Save PDF]
```

## Architecture

```
User ←→ Claude / Any MCP Client
              |
         MCP Server (FastMCP, stdio) — 20 tools
              |
    +---------+---------+----------+-----------+
    |         |         |          |           |
 Geotab   OData DC   DuckDB   Gemini AI   Google
  API     (KPIs)     Cache    (analysis)   Geocoding
    |                                        |
    +--- Flask Web Dashboard (port 5030) ---+
         Google Maps JS API
         Gemini Chat + Function Calling
         Gemini Native Audio (TTS)
         Geotab Ace AI
         SQLite Vehicle Enrichment
         SQLite Response Cache (DB-first)
```

## Features

### Dashboard UI
- **Real-time vehicle markers** on Google Maps with status colors (green=moving, grey=stopped, red=fault, dark=offline)
- **Auto-refresh** every 10 seconds with batch location fetching (1 API call for all vehicles)
- **Vehicle detail panel** — click any marker for driver, department, make/model, VIN, odometer, engine hours, faults, trips
- **Vehicle search** — filter by name, driver, department, or make
- **Fleet KPI cards** — total distance, trips, idle %, driving hours, max speed, exceptions
- **Geofence overlays** with estimated radius rendering from polygon data
- **Dark/light theme** with glass-morphism styling

### Map Controls
- **Heatmap** — activity density visualization across the fleet operating area (~1000 synthetic points from vehicle positions)
- **Lock View** — prevent auto-pan/zoom on data refresh so you can inspect a specific area
- **Solo Mode** — hide all markers except the selected vehicle for focused tracking
- **Fit All** — one-click zoom to show the entire fleet

### Trip Replay
- **GPS breadcrumb animation** with play/pause/speed controls
- **Speed-colored path** — green (slow), yellow (normal), red (fast), grey (stopped)
- **Live telemetry HUD** — speed, acceleration, distance, elapsed time, avg/max speed
- **Slider scrubbing** — jump to any point in the trip

### Fleet Reports
- **Executive report** generated by Gemini AI + Geotab Ace AI
- **Resizable slide-out panel** with drag handle (report + guide tabs)
- **Export**: Print, Save as HTML (standalone file with embedded styles), Save as PDF (via browser print)
- **Pop-out**: Open report or guide in standalone browser tab
- Sections: Executive Summary, Fleet Overview, Top Performers, Anomalies, Ace AI Insights, Recommendations

### AI Chat (Fleet Assistant)
- **Gemini AI** with function calling — natural language fleet queries across 12 tools
- **Action commands**: create geofences, send text messages to vehicles, query exceptions
- **Voice input** via Web Speech API with interim transcription
- **Text-to-speech** for AI responses (browser speechSynthesis)
- **Session history** with clear/reset

### MCP Server
- **20 tools** exposing full Geotab fleet data to any MCP-compatible AI assistant
- Works with Claude Desktop, Claude Code, or any MCP client
- Enables fleet management via natural language from any AI interface
- Separate from the dashboard — can run standalone via stdio

### Automated Demo
- **3-minute guided tour** showcasing every feature with TTS narration
- **Gemini Native Audio** (Live API) for narrator voice with persistent MP3 caching
- **Voice-triggered chat queries** — mic button pulses red, text typewriters into input, then sends
- **Solo Mode** integration during trip replay (ON before, OFF after)
- Trigger: say "play the demo" in chat, type it, or use `?demo=1` URL parameter

### Geotab Ace AI
- Direct natural language queries against the fleet dataset
- Integrated into executive reports for fleet-native insights
- Standalone `/api/ace` endpoint

### Vehicle Enrichment Layer
- **SQLite database** (`fleet_enrichment.db`) overlays realistic fleet data onto the demo dataset
- 50-vehicle Canadian mixed fleet: 15 vans, 12 pickups, 8 sedans, 8 SUVs, 4 EVs, 3 heavy trucks
- Driver names, departments (Delivery/Service/Sales/Executive/Field Ops), odometers, engine hours, VINs
- **Toggle on/off** via `/api/enrichment/toggle` — clean API-only fallback
- API real-time fields (GPS, speed, status) always take priority

### Caching (DB-First Architecture)
- **Persistent SQLite response cache** — all API responses dual-written to memory + SQLite
- **DB-first on startup** — cache warming loads from SQLite, zero API calls for first page load
- **TTL-based in-memory cache** on all API routes (vehicles 60s, locations 30s, trips 5min, zones 5min, faults 2min)
- **Stale-serve fallback** — returns cached data when API is rate-limited or unavailable
- **Batch location fetching** — 1 API call for all vehicles instead of N+1
- **`?refresh=1`** query param to force-bypass both memory and DB cache

### API Call Tracker
- **SQLite database** (`api_tracker.db`) logs every external API call (Geotab, Gemini, Ace)
- Tracks service, method, status, response time (ms), errors, and cache hits
- **`/api/tracker`** endpoint returns usage summary (grouped by service/status) + recent calls
- Supports `?hours=N` and `?limit=N` query params for filtering

## MCP Tools (20)

| Category | Tool | Description |
|----------|------|-------------|
| **Utility** | `test_connection` | Validate API connectivity |
| **Fleet Overview** | `get_fleet_vehicles` | List all vehicles with status/VIN/odometer |
| | `get_vehicle_details` | Deep dive on one vehicle |
| | `get_fleet_drivers` | List all drivers |
| | `get_zones` | List all geofences |
| **Real-Time** | `get_vehicle_location` | Current GPS + speed |
| | `get_active_faults` | Active DTCs across fleet |
| **History** | `get_trip_history` | Trips with distance/duration/speed |
| | `get_fuel_analysis` | Fuel transactions and costs |
| | `get_exception_events` | Rule violations |
| **KPIs** | `get_safety_scores` | Driver safety via Data Connector |
| | `get_fleet_kpis` | Daily fleet KPIs via Data Connector |
| **Actions** | `create_geofence` | Create zones from coordinates |
| | `send_message` | Text message to in-cab device |
| **Analytics** | `query_fleet_data` | SQL over cached DuckDB data |
| | `list_cached_datasets` | Show cached tables |
| | `export_data` | Export to JSON/CSV |
| **Google AI** | `gemini_analyze` | Delegate fleet data analysis to Gemini AI |
| **Google Maps** | `geocode_address` | Convert address to GPS coordinates |
| | `create_geofence_from_address` | One-shot geofence from street address |

## Dashboard API Routes (21)

| Method | Route | Description |
|--------|-------|-------------|
| GET | `/` | Main dashboard page |
| GET | `/guide` | Standalone user guide page |
| GET | `/api/guide` | User guide content (markdown) |
| GET | `/api/vehicles` | All vehicles with GPS positions (enriched) |
| GET | `/api/vehicle/<id>/location` | Single vehicle real-time GPS |
| GET | `/api/vehicle/<id>/trips` | Trip history with route points |
| GET | `/api/vehicle/<id>/trip-replay` | GPS log records for animated replay |
| GET | `/api/zones` | All geofence zones with estimated radius |
| GET | `/api/faults` | Active fault codes |
| GET | `/api/status` | Connection status + fleet summary |
| GET | `/api/fleet-kpis` | Aggregated fleet KPIs |
| GET | `/api/heatmap-data` | Activity heatmap points |
| POST | `/api/report` | Generate executive report (Gemini + Ace AI) |
| POST | `/api/ace` | Ask Geotab Ace AI a question |
| POST | `/api/chat` | Gemini AI chat with function calling |
| POST | `/api/chat/clear` | Clear chat session |
| GET | `/api/tracker` | API call usage summary + recent calls |
| GET | `/api/enrichment/status` | Check enrichment toggle state |
| POST | `/api/enrichment/toggle` | Toggle vehicle enrichment on/off |
| POST | `/api/tts` | Text-to-speech via Gemini Native Audio |
| POST | `/api/tts/warmup` | Pre-record all demo narration lines |

## Quick Start

### 1. Install

```bash
git clone https://github.com/harmsolo13/geotab-fleet-mcp.git
cd geotab-fleet-mcp
pip install -e .
```

### 2. Configure Credentials

```bash
cp .env.example .env
# Edit .env with your credentials:
# GEOTAB_DATABASE=your_database
# GEOTAB_USERNAME=your_email@example.com
# GEOTAB_PASSWORD=your_password
# GEOTAB_SERVER=my.geotab.com
# GEMINI_API_KEY=your_gemini_key
# GOOGLE_MAPS_API_KEY=your_maps_key
```

**API keys needed:**
- **Geotab**: MyGeotab account credentials ([create demo database](https://my.geotab.com/registration.html))
- **Gemini AI**: Get key at [Google AI Studio](https://aistudio.google.com/apikey)
- **Google Maps**: Get key at [Google Cloud Console](https://console.cloud.google.com/apis/credentials) — enable **Maps JavaScript API** + **Geocoding API**

### 3. Run the MCP Server

```bash
# With Claude Desktop — add to claude_desktop_config.json:
{
  "mcpServers": {
    "geotab-fleet": {
      "command": "python",
      "args": ["-m", "geotab_mcp.server"],
      "cwd": "/path/to/geotab-fleet-mcp/src"
    }
  }
}

# With Claude Code
claude mcp add geotab-fleet -- python -m geotab_mcp.server

# With MCP inspector
mcp dev src/geotab_mcp/server.py
```

### 4. Run the Dashboard

```bash
# Start the Google Maps dashboard on port 5030
python -m geotab_mcp.dashboard

# Or use the CLI entry point
geotab-dashboard
```

Open [http://localhost:5030](http://localhost:5030) to see the live fleet map.

### 5. Run the Demo

Open [http://localhost:5030/?demo=1](http://localhost:5030/?demo=1) — or open the chat and say "play the demo" to launch a fully automated 3-minute narrated tour.

## Tech Stack

- **Python 3.10+** — Backend
- **FastMCP** (`mcp`) — MCP server framework
- **mygeotab** — Official Geotab Python SDK
- **httpx** — HTTP client for OData + Google APIs
- **DuckDB** — Embedded analytics cache
- **SQLite** — Vehicle enrichment + response cache + API tracker
- **Flask** — Web dashboard backend
- **Google Maps JavaScript API** — Live fleet map with AdvancedMarkerElement
- **Google Maps HeatmapLayer** — Activity density visualization
- **Google Geocoding API** — Address-to-coordinates
- **Google Gemini AI** (`google-genai`) — Fleet analysis + chat with function calling
- **Google Gemini Native Audio** (Live API) — TTS narration with MP3 caching
- **Geotab Ace AI** — Fleet-native natural language analytics
- **Web Speech API** — Voice input + browser TTS
- **Pydantic** — Data validation
- **python-dotenv** — Environment configuration

## File Structure

```
geotab-fleet-mcp/
├── src/geotab_mcp/
│   ├── server.py          # MCP server — 20 tools (549 lines)
│   ├── dashboard.py        # Flask web dashboard — 21 API routes (1236 lines)
│   ├── geotab_client.py    # Geotab API wrapper + batch locations (582 lines)
│   ├── gemini_client.py    # Gemini AI chat + function calling (596 lines)
│   ├── enrichment.py       # SQLite vehicle enrichment layer (220 lines)
│   ├── api_tracker.py      # SQLite API call tracker + response cache (211 lines)
│   ├── data_connector.py   # OData v4 Data Connector client (178 lines)
│   ├── cache.py            # DuckDB caching layer (142 lines)
│   ├── google_maps.py      # Geocoding + geofence creation (133 lines)
│   └── __init__.py
├── templates/
│   └── dashboard.html      # Single-page dashboard template (235 lines)
├── static/
│   ├── js/fleet-map.js     # Map, chat, replay, heatmap, controls (1513 lines)
│   ├── js/demo.js          # Automated demo with TTS narration (793 lines)
│   └── css/dashboard.css   # Dark/light theme, glass morphism (1558 lines)
├── static/audio/tts_cache/ # Pre-recorded narrator MP3s (Gemini Native Audio)
├── fleet_enrichment.db     # SQLite enrichment data (50 vehicles)
├── api_tracker.db          # SQLite API call log + response cache
├── README.md
├── PROMPTS.md              # AI prompts used during development
├── DEMO_NARRATION.md       # Demo script with timing
└── pyproject.toml
```

**Total: ~7,950 lines of code across 13 source files.**

## Demo Scenarios

1. **Voice trigger**: Say "play the demo" → fully automated 3-minute narrated tour
2. **Fleet overview**: *"Show me all vehicles and their current status"*
3. **Vehicle detail**: Click any marker → driver, department, make/model, trips, faults
4. **Solo Mode**: Isolate a single vehicle, hide all other fleet markers
5. **Trip replay**: Click a trip's play button → animated GPS breadcrumb with speed HUD
6. **Heatmap**: Toggle heatmap to see fleet activity density
7. **Report**: Click Report → executive analysis from Gemini + Ace AI → Print/Save
8. **Chat**: *"Create a geofence called Fleet Operations Zone at 43.52, -79.69 with a 2km radius"*
9. **Voice**: Click mic → speak → AI responds with voice + text
10. **Ace AI**: *"What are the top fuel consumers in my fleet?"*
11. **Theme toggle**: Switch between dark and light mode

## Competition

Built for the [Geotab Vibe Coding Competition 2026](https://luma.com/h6ldbaxp). Targeting:
- **Vibe Master** ($10K) — Best overall solution
- **The Innovator** ($5K) — Technical creativity with AI-powered fleet intelligence
- **Best Use of Google Tools** ($2.5K) — Google Maps dashboard, Gemini AI chat + function calling, Gemini Native Audio TTS, Google Geocoding

## Team

Built by 2 developers using **Claude Code** (Claude Opus 4.6) as the primary vibe coding partner.

## License

MIT
